# Mind Map Explorer API Documentation

## Overview
This document provides comprehensive documentation for all RESTful API endpoints in the Mind Map Explorer project, including their purpose, request/response formats, and end-to-end behavior. It also details the automated tests, their order, and what each test covers.

---

## API Endpoints

### User Endpoints

#### Create User
- **POST** `/users`
- **Handler:** `createuser.py`
- **Description:** Create a new user.
- **Request Body:**
  ```json
  { "name": "string", "email": "string" }
  ```
- **Response (201):**
  ```json
  { "Id": "string", "name": "string", "email": "string", "createdAt": "ISO-timestamp" }
  ```

#### Get User
- **GET** `/users/{userId}`
- **Handler:** `getuser.py`
- **Description:** Retrieve a user by their ID.
- **Response (200):**
  ```json
  { "Id": "string", "name": "string", "email": "string", "createdAt": "ISO-timestamp" }
  ```

#### Update User
- **PUT** `/users/{userId}`
- **Handler:** `updateuser.py`
- **Description:** Update user details.
- **Request Body:**
  ```json
  { "name": "string", "email": "string" }
  ```
- **Response (200):** Updated user object.

#### Delete User
- **DELETE** `/users/{userId}`
- **Handler:** `deleteuser.py`
- **Description:** Delete a user by ID.
- **Response (204):** No content.

#### List Users
- **GET** `/users`
- **Handler:** `listusers.py`
- **Description:** List all users.
- **Response (200):** Array of user objects.

---

### Space Endpoints

#### Create Space
- **POST** `/spaces`
- **Handler:** `spaces_create_handler.py`
- **Description:** Create a new mind map space.
- **Request Body:**
  ```json
  { "name": "string", "description": "string", "ownerId": "string" }
  ```
- **Response (201):**
  ```json
  { "spaceId": "string", "name": "string", "description": "string", "createdAt": "ISO-timestamp" }
  ```

#### List Spaces
- **GET** `/spaces`
- **Handler:** `spaces_list_handler.py`
- **Description:** List all spaces for the user.
- **Response (200):** Array of space objects.

#### Get Space (Tree)
- **GET** `/spaces/{spaceId}`
- **Handler:** `spaces_tree_handler.py`
- **Description:** Get a space and its full node tree.
- **Response (200):**
  ```json
  { "spaceId": "string", "name": "string", "nodes": [ { "nodeId": "string", "title": "string", "children": [ ... ] } ] }
  ```

#### Update Space
- **PUT** `/spaces/{spaceId}`
- **Handler:** `spaces_update_handler.py`
- **Description:** Update a space's name or description.
- **Request Body:**
  ```json
  { "name": "string", "description": "string" }
  ```
- **Response (200):** Updated space object.

#### Delete Space
- **DELETE** `/spaces/{spaceId}`
- **Handler:** `spaces_delete_handler.py`
- **Description:** Delete a space and all its nodes/content.
- **Response (204):** No content.

---

### Node Endpoints

#### Add Node
- **POST** `/spaces/{spaceId}/nodes`
- **Handler:** `nodes_add_handler.py`
- **Description:** Add a new node to a space. Optionally includes HTML content (stored in S3). If `contentHTML` is omitted, event-driven AI content generation is triggered and the result is stored in S3 and referenced in DynamoDB.
- **Request Body:**
  ```json
  { "title": "string", "contentHTML": "string", "parentNodeId": "string|null", "orderIndex": 0 }
  ```
- **Response (201):**
  ```json
  { "nodeId": "string", "title": "string", "parentNodeId": "string|null", "orderIndex": 0, "s3Key": "string" }
  ```

#### Get Node
- **GET** `/spaces/{spaceId}/nodes/{nodeId}`
- **Handler:** `nodes_get_handler.py`
- **Description:** Get a node's metadata and content. If content was generated by AI, the `contentHTML` field is populated from S3.
- **Response (200):**
  ```json
  { "nodeId": "string", "title": "string", "contentHTML": "string", "parentNodeId": "string|null", "orderIndex": 0 }
  ```

#### Update Node
- **PUT** `/spaces/{spaceId}/nodes/{nodeId}`
- **Handler:** `nodes_update_handler.py`
- **Description:** Update a node's title or content. If `contentHTML` is provided, it is stored in S3 and referenced in DynamoDB.
- **Request Body:**
  ```json
  { "title": "string", "contentHTML": "string" }
  ```
- **Response (200):** Updated node object.

#### Delete Node
- **DELETE** `/spaces/{spaceId}/nodes/{nodeId}`
- **Handler:** `nodes_delete_handler.py`
- **Description:** Delete a node and its content from S3.
- **Response (204):** No content.

#### Reorder Nodes
- **POST** `/spaces/{spaceId}/nodes/reorder`
- **Handler:** `nodes_reorder_handler.py`
- **Description:** Reorder nodes within a space.
- **Request Body:**
  ```json
  [
    { "nodeId": "string", "newOrderIndex": 0 },
    { "nodeId": "string", "newOrderIndex": 1 }
  ]
  ```
- **Response (200):** Confirmation or updated order.

---

### Content Generation (Event-Driven)

- When a node is created **without** `contentHTML`, an event is published to EventBridge.
- A Lambda function is triggered, which generates content (e.g., via Bedrock or another AI provider).
- The generated content is stored in S3 (`content.html`), and the S3 key is saved in the node's DynamoDB record.
- When the node is retrieved, the API loads the content from S3 and returns it as `contentHTML`.
- This workflow is fully automated and tested end-to-end.

---

## End-to-End Documentation

### Event-Driven Content Generation Workflow
1. **Node Creation**: When a node is created via `POST /spaces/{spaceId}/nodes` without `contentHTML`, the system publishes an event to EventBridge.
2. **AI Content Generation**: A Lambda function is triggered by the event, generates content (e.g., using Bedrock or another AI provider), and stores the result in S3. The S3 key is saved in the node's DynamoDB record.
3. **Content Retrieval**: When a node is retrieved via `GET /spaces/{spaceId}/nodes/{nodeId}` or the full tree via `GET /spaces/{spaceId}`, the API loads the content from S3 and returns it as `contentHTML`.
4. **Content Update**: If a node is updated with new `contentHTML`, it is stored in S3 and the S3 key is updated in DynamoDB.
5. **Content Deletion**: Deleting a node or space removes the associated content from S3 and the node record from DynamoDB.

### Logging Strategy
- **API Gateway & Lambda**: All API endpoints and Lambda handlers log incoming requests, key actions, and errors using a centralized logging utility (see `serverless/lambda_handlers/utils/logger.py`).
- **EventBridge Events**: Events published for content generation are logged with event details and correlation IDs.
- **Content Generation Lambda**: Logs event receipt, content generation start/end, S3 upload status, and any errors.
- **DynamoDB & S3 Operations**: All read/write/delete operations log success and failure, including resource identifiers.
- **Error Handling**: All exceptions are logged with stack traces and relevant context for debugging.
- **Audit Trail**: Logs include user IDs, space IDs, node IDs, and timestamps for traceability.

---

## End-to-End API Working
1. **User creates a space** (`POST /spaces`).
2. **User adds nodes** to the space (`POST /spaces/{spaceId}/nodes`).
3. **If no contentHTML is provided, AI content is generated and stored in S3.**
4. **User can get the full tree** (`GET /spaces/{spaceId}`) or individual nodes (`GET /spaces/{spaceId}/nodes/{nodeId}`).
5. **User updates nodes or spaces** as needed (`PUT` endpoints).
6. **User deletes nodes or spaces** (`DELETE` endpoints), which also cleans up S3 content.
7. **Node order can be changed** with the reorder endpoint.

---

## Automated Tests

### Test Files
- `tests/test_spaces_api.py`: Tests for space endpoints.
- `tests/test_nodes_api.py`: Tests for node endpoints.
- `tests/test_complete_workflow.py`: End-to-end event-driven and direct content generation workflow.

### Test Order and Coverage

#### 1. Space Tests (`test_spaces_api.py`)
- **test_create_space**: Creates a new space and asserts a 201 response with a valid spaceId.
- **test_list_spaces**: Lists all spaces and checks for a 200 response and correct format.
- **test_space_lifecycle**: Full lifecycle:
  - Create a space
  - Get the space
  - Update the space
  - Delete the space
  - Confirm deletion

#### 2. Node Tests (`test_nodes_api.py`)
- **test_add_get_update_delete_node**: End-to-end node lifecycle:
  - Add a node to a test space
  - Get the node
  - Update the node
  - Delete the node
  - Confirm deletion
- **test_recursive_node_deletion**: Tests that deleting a parent node recursively deletes all child nodes.

#### 3. Complete Workflow Test (`test_complete_workflow.py`)
- **test_complete_mindmap_workflow**: Full end-to-end test of space, node, event-driven AI content generation, S3 storage, tree structure, update, reorder, and cleanup.

#### Test Execution Order
- Space tests run first to ensure a valid space exists for node tests.
- Node tests use a fixture to create a test space, add nodes, and clean up after.

### What Each Test Does (End-to-End)
- **Space tests** verify creation, retrieval, update, deletion, and listing of spaces.
- **Node tests** verify node creation, retrieval, update, deletion, and recursive deletion logic, including S3 integration for content.
- **Complete workflow test** verifies the event-driven content generation, S3/DynamoDB integration, and all major API flows.

---

## Notes
- All endpoints use correct RESTful status codes (201 for create, 200 for get/update, 204 for delete).
- Error responses are structured and informative.
- S3 and DynamoDB integration is robust and tested.
- IAM permissions are set for development; restrict in production.

---

For further details, see `API_STATUS_AND_ROADMAP.md` and `product_specs.md` in the project root.
